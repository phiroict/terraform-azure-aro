# terraform-azure-aro
This code will first standup VNET, Bastion and firewall for the Azure Private network.

This can be used to run ARO install for internal network.

The original project made by `thoward-rh` has been turned into a module so it inspires more reuse. 

Base setup: 

![Diagram system](docs/images/ARO_Baseline_Infra.jpg)


# Creating the infrastructure on Azure.
IMPORTANT: First ensure you are logged into the right Azure account with the right access.
You also need into increase the standard CPU allocations / ensure these are sufficient. 
You need for running the demo ARO cluster that is generated by:  

`az aro create --resource-group MyResourceGroup --name aro_cluster --vnet myVnet --master-subnet myControlPlaneSubnet --worker-subnet myWorkerSubnet --apiserver-visibility Private --ingress-visibility Private --worker-vm-size Standard_D4as_v4`

These quotas

| CPU family | Number of vCPUs | Default for PayG sub |
| --- | --- | --- |
| Cores | 50 | 10 |
| standardDSv3Family | 20 | 10 | 
| standardDASv4Family | 20 | 10 |


Before you start log in to the correct subscription 


`make login`

Make sure you enable the redhat repo in your Azure subscription, you need to do this only once.

`make init_az`


Initialise your terraform directory. You need this once, and also when the module is changed. 

`make init`

Run the plan

`make plan`

Apply to the infra

`make apply`

You can do plan and appy in one go 

`make all`

After the install, create your private key and use it to access the Bastion host which was created in the terraform apply.

The result of applying the terraform will be the following:
* 1 VNET and 4 subnets (mySubnet, myControlPlaneSubnet, myWorkerSubnet, AzureFirewallSubnet)
* 1 firewall with static IP address
* Firewall rules to allow internal subnets access to the addresses required to install OpenShift (ie quay.io)
* 1 routing table which adds the worker and control plane subnets to default routing to the firewall. User Defined Routing (UDR)
* 1 CentOS VM which we will use for Bastion, this also has a dynamic public IP address (may change to use firewall later)
* The commandline `az aro create ...` you need to run to create the cluster, note that you need to have set up the CPU quotas first.


# Create cluster variables

```bash

LOCATION=southeastasia                 # the location of your cluster
RESOURCEGROUP=myResourceGroup            # the name of the resource group where you want to create your cluster
CLUSTER=cluster                 # the name of your cluster
VNET=myVnet
SUBNETMASTER=myControlPlaneSubnet
SUBNETWORKER=myWorkerSubnet

```

# Create cluster

```bash
az aro create \
  --resource-group $RESOURCEGROUP \
  --name $CLUSTER \
  --vnet $VNET \
  --master-subnet $SUBNETMASTER \
  --worker-subnet $SUBNETWORKER \
  --apiserver-visibility Private \
  --ingress-visibility Private \
  --domain uluvus.private \
  --pull-secret @pull-secret.txt
  # don't forget to add "\" if you remove the comments.
```